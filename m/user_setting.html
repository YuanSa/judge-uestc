<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <!--meta http-equiv="refresh" content="1"><!---->
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>个人设置</title>
    <link rel="stylesheet" href="css/public.css">
    <link rel="stylesheet" href="css/component.css">
    <link rel="stylesheet" href="css/user_setting.css">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><body>
    <div class="info">
        <div class="avatar">
            <img id="avatar" src="../img/avatars/default.png" alt="头像">
            <div class="tag">未认证</div>
        </div>
        <div class="text">
            <div class="name" id="nowNickname">用户名</div>
            <div class="counters">
                <div class="counter">
                    <div class="key">打分</div>
                    <div class="value" id="num_judge">-</div>
                </div>
                <div class="counter">
                    <div class="key">评论</div>
                    <div class="value" id="num_description">-</div>
                </div>
            </div>
        </div>
    </div>
    <div class="settings">
        <div class="panels">
            <div class="panel">基础</div>
            <div class="panel">调整权重</div>
            <div class="panel">安全</div>
            <div class="panel">评教记录</div>
            <div class="panel">认证</div>
            <div class="panel">销号</div>
        </div>
        <div class="detail">
            <form onsubmit="return false;">
                <h1>基础信息</h1>
                <table class="plain">
                    <tr>
                        <td>昵称</td>
                        <td><input type="text" onfocus="this.select()" id="nickname"></td>
                    </tr>
                </table>
                <div class="actions">
                    <button type="submit" class="pill" id="submit_nickname" onclick="submitNickname()"></button>
                    <div class="notice" id="notice_nickname"></div>
                </div>
                <h1>修改头像</h1>
                <p>为了节约服务器开支，仅支持选定头像。欢迎投稿新的头像！</p>
                <div class="avatars">
                    <img src="../img/avatars/1.png" alt="" value="1">
                    <img src="../img/avatars/2.png" alt="" value="2">
                    <img src="../img/avatars/3.png" alt="" value="3">
                    <img src="../img/avatars/4.png" alt="" value="4">
                    <img src="../img/avatars/5.png" alt="" value="5">
                    <img src="../img/avatars/6.png" alt="" value="6">
                    <img src="../img/avatars/7.png" alt="" value="7">
                    <img src="../img/avatars/8.png" alt="" value="8">
                    <img src="../img/avatars/9.png" alt="" value="9">
                    <img src="../img/avatars/10.png" alt="" value="10">
                    <img src="../img/avatars/11.png" alt="" value="11">
                    <img src="../img/avatars/12.png" alt="" value="12">
                    <img src="../img/avatars/13.png" alt="" value="13">
                    <img src="../img/avatars/14.png" alt="" value="14">
                    <img src="../img/avatars/15.png" alt="" value="15">
                </div>
                <div class="actions">
                    <button type="submit" class="pill" id="submit_avatar" onclick="submitAvatar()"></button>
                    <div class="notice" id="notice_avatar"></div>
                </div>
            </form>
        </div>
        <div class="detail">
            <form onsubmit="return false;">
                <h1>调整权重</h1>
                <p>您可以修改以下各项分值对您的权重，以此实现各老师评分排名的个性定制。</p>
                <div class="weights">
                    <div class="item">
                        给分 <input type="number" class="weight" onfocus="this.select()" id="weight_score" max="10" min="0" value="1">
                    </div>
                    <div class="item">
                        质量 <input type="number" class="weight" onfocus="this.select()" id="weight_quality" max="10" min="0" value="1">
                    </div>
                    <div class="item">
                        容易 <input type="number" class="weight" onfocus="this.select()" id="weight_easy" max="10" min="0" value="1">
                    </div>
                </div>
                <div class="hints">
                    <p>例如：您更看重老师上课的质量，而不在乎给分高低；您可以设置给分权重为0，质量权重为3。</p>
                    <p>这样的话，若原本元卅老师的综合评分为：$$2 = {1+4+1 \over 3}$$调整后则会变为：$$4.3 = {1 \times 0 + 4 \times 3 + 1 \times 1 \over 3}$$调整后的得分对您更有针对性。</p>
                </div>
                <div class="actions">
                    <button type="submit" class="pill" id="submit_weight" onclick="submitWeight()"></button>
                    <div class="notice" id="notice_weight"></div>
                </div>
            </form>
        </div>
        <div class="detail">
            <form onsubmit="return false;">
                <p>您的帐号为“元卅馆”账号，此页面的修改将同步到“元卅馆”旗下所有产品。</p>
                <p class="area_1_hide">请选择一种方式验证您的身份：</p>
                <p class="area_1_show" style="display: none">您尚未设置密保问题，请输入您当前密码以验证身份</p>
                <div class="radioSet area_1_hide">
                    <button type="button" class="section_1_panel" id="section_1_a">密码</button>
                    <button type="button" class="section_1_panel" id="section_1_b">密保问题</button>
                </div>
                <table class="plain">
                    <tr class="section_1 section_1_a area_1_show">
                        <td>原密码</td>
                        <td><input type="password" id="verify_pw"></td>
                    </tr>
                    <tr class="section_1 section_1_b area_1_hide">
                        <td>密保问题1</td>
                        <td class="area_1_value_1">正在获取密保问题1</td>
                    </tr>
                    <tr class="section_1 section_1_b area_1_hide">
                        <td>回答</td>
                        <td><input type="text" id="verify_ans1"></td>
                    </tr>
                    <tr class="section_1 section_1_b area_1_hide">
                        <td>密保问题2</td>
                        <td class="area_1_value_2">正在获取密保问题2</td>
                    </tr>
                    <tr class="section_1 section_1_b area_1_hide">
                        <td>回答</td>
                        <td><input type="text" id="verify_ans2"></td>
                    </tr>
                </table>
                <h1>修改用户名</h1>
                <table class="plain">
                    <tr>
                        <td>用户名</td>
                        <td><input type="text" onfocus="this.select()" id="username"></td>
                    </tr>
                </table>
                <div class="actions">
                    <button type="submit" class="pill" id="submit_username" onclick="submitUsername();"></button>
                    <div class="notice" id="notice_username"></div>
                </div>
                <h1>修改密码</h1>
                <table class="plain">
                    <tr class="split"></tr>
                    <tr>
                        <td>新密码</td>
                        <td><input type="password" id="password"></td>
                    </tr>
                    <tr>
                        <td>重复新密码</td>
                        <td><input type="password" id="password_repeat"></td>
                    </tr>
                </table>
                <div class="actions">
                    <button type="submit" class="pill" id="submit_password" onclick="submitPassword();"></button>
                    <div class="notice" id="notice_password"></div>
                </div>
            </form>
            <form onsubmit="return false;">
                <h1>设置新密保</h1>
                <table class="plain">
                    <tr>
                        <td>选择问题</td>
                        <td><select id="qna_q1">
                            <option value="我的出生地">我的出生地</option>
                            <option value="我父亲的真实姓名">我父亲的真实姓名</option>
                            <option value="我母亲的真实姓名">我母亲的真实姓名</option>
                            <option value="我就读的第一所学校">我就读的第一所学校</option>
                            <option value="我本科的专业名">我本科的专业名</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>回答</td>
                        <td><input type="text" id="qna_a1"></td>
                    </tr>
                    <tr>
                        <td>选择问题</td>
                        <td><select id="qna_q2">
                            <option value="我童年挚友的名字">我童年挚友的名字</option>
                            <option value="我初恋的名字">我初恋的名字</option>
                            <option value="我第一只宠物的名字">我第一只宠物的名字</option>
                            <option value="我最喜欢的一座城市">我最喜欢的一座城市</option>
                            <option value="我最喜欢的食物">我最喜欢的食物</option>
                        </select></td>
                    </tr>
                    <tr>
                        <td>回答</td>
                        <td><input type="text" id="qna_a2"></td>
                    </tr>
                </table>
                <div class="actions">
                    <button type="submit" class="pill" id="submit_qna" onclick="submitQna();"></button>
                    <div class="notice" id="notice_qna"></div>
                </div>
            </form>
        </div>
        <div class="detail">
            <form onsubmit="return false;">
                <h1>评教记录</h1>
                <p class="important">该功能正在建设中，目前不开放。如有需要请联系管理员人工处理。</p>
                <table class="plain">
                </table>
                <div class="actions" style="display: none">
                    <button type="submit" class="pill"></button>
                </div>
            </form>
        </div>
        <div class="detail">
            <form onsubmit="return false;">
                <h1>学生认证</h1>
                <p>请提交您的电子科技大学教务系统账号、密码。您提交的信息将被存储在服务器，并会在认证结束后被删除。</p>
                <p>如果您不信任本站，可以不认证。</p>
                <p>目前，不认证不会影响您的任何使用，但未来可能会对未认证用户施加降低权重等限制。</p>
                <p class="important">该功能正在筹备中，目前不开放。</p>
                <table class="plain">
                </table>
                <div class="actions" style="display: none">
                    <button type="submit" class="pill"></button>
                </div>
            </form>
        </div>
        <div class="detail">
            <form onsubmit="return false;">
                <h1>销毁账号</h1>
                <p>您的帐号将被销毁！此操作不可恢复！</p>
                <p class="important">该功能正在建设中，目前不开放。如有需要请联系管理员人工处理。</p>
                <table class="plain">
                </table>
                <div class="actions" style="display: none">
                    <button type="submit" class="pill"></button>
                </div>
            </form>
        </div>
    </div>
    <!--
    <div class="actions">
        <button class="pill">
            <svg viewBox="0 0 1024 1024" width="200" height="200">
                <path d="M843.693959 293.609061 425.255869 712.056362 186.145026 472.947566 66.579883 592.504522 425.255869 951.165158 963.260126 413.174204Z"></path>
            </svg>
        </button>
    </div>
    -->
    <div class="uid_outer">
        <div class="uid" id="uid">Loading...</div>
    </div>
    
</body>
<script src="../js/universal.js"></script>
<script>
    let panel = document.getElementsByClassName("panel");
    var detail = document.getElementsByClassName("detail");
    for(i in panel) {
        let k = i;
        panel[i].onclick = function() {
            panelSelect(k);
        }
    }
    let pills = document.getElementsByClassName("pill");
    for(pill of pills) {
        pill.innerHTML = '\
            <svg viewBox="0 0 1024 1024" width="200" height="200">\
            <path d="M843.693959 293.609061 425.255869 712.056362 186.145026 472.947566 66.579883 592.504522 425.255869 951.165158 963.260126 413.174204Z"></path>\
            </svg>\
        ';
    }

    let sectionPanels = [], sections = [];
    let sectionNum = 1;
    for(let i = 1; i <= sectionNum; i++) {
        sectionPanels[i] = document.getElementsByClassName("section_"+i+"_panel");
        sections[i] = document.getElementsByClassName("section_"+i);
        for(sectionPanel of sectionPanels[i]) {
            //之前通过 universal.js 实现 radioSet 组件的视觉效果
            //为了防止绑定 onclick 事件覆盖组件视觉效果事件，使用 oldFunction 转存
            //但因为遇到了很多 BUG 目前废弃了这种实现
            //let oldFunction = sectionPanel.onclick;
            sectionPanel.oldClassName = sectionPanel.className;
            sectionPanel.onclick = function() {
                //oldFunction.call(sectionPanel);
                for(sectionPanel of sectionPanels[i]) {
                    sectionPanel.className = "section_"+i+"_panel";
                    sectionPanel.setAttribute("value", 0);
                }
                this.className = "section_"+i+"_panel selected";
                this.setAttribute("value", 1);
                for(section of sections[i]) {
                    section.style.display = "none";
                }
                let sectionItems = document.getElementsByClassName(this.id);
                for(sectionItem of sectionItems) {
                    sectionItem.style.display = "";
                }
            }
        }
        sectionPanels[i][0].click();
    }

    panelSelect(0);
    function panelSelect(i) {
        for(let j = 0; j < panel.length; j++) {
            panel[j].className = "panel";
        }
        panel[i].className = "panel selected";
        for(let j = 0; j < detail.length; j++) {
            detail[j].style.display = "none";
        }
        detail[i].style.display = "flex";
    }
    let uid = getCookie("uid");
    ajaxTo("POST", "../php/user/get_info.php", {uid: uid}, function(json) {
        if(json.state == "success") {
            document.getElementById("num_judge").innerHTML = json.numJudge;
            document.getElementById("num_description").innerHTML = json.numDescription;
        }
    });
    

    //------------【设置 初始化及响应】------------

    //---[Page 1]---------
    //  昵称
    //--------------------
    document.getElementById("uid").innerHTML = "UID: " + uid;
    let nowNickname = document.getElementById("nowNickname");
    let nodeNickname = document.getElementById("nickname");
    nowNickname.innerHTML = getCookie("nickname");
    nodeNickname.value = getCookie("nickname");
    function submitNickname() {
        let btn = document.getElementById("submit_nickname");
        let notice = document.getElementById("notice_nickname");
        btn.style.backgroundColor = "orange";
        btn.style.fill = "white";
        notice.innerHTML = "正在处理";
        let newNickname = nodeNickname.value;
        if(newNickname) {
            ajaxTo("POST", "../php/user/set_nickname.php", {nickname: newNickname}, function(json) {
                if(json.state == "success") {
                    btn.style.backgroundColor = "green";
                    document.getElementById("nowNickname").innerHTML = newNickname;
                    notice.innerHTML = "成功";
                } else {
                    btn.style.backgroundColor = "red";
                    notice.innerHTML = "错误：[" + json.code + "] " + json.message;
                }
            });
        } else {
            btn.style.backgroundColor = "red";
            notice.innerHTML = "昵称不能为空";
        }
    }

    //--------------------
    //  头像
    //--------------------
    let avatars = document.getElementsByClassName("avatars")[0].children;
    var avatarIndex = getCookie("avatar");
    for(avatar of avatars) {
        avatar.onclick = function() {
            for(avatar of avatars) avatar.className = "";
            avatarIndex = this.getAttribute("value");
            this.className = "selected";
        }
    }
    document.getElementById("avatar").src = "../img/avatars/" + avatarIndex +".png";
    avatars[parseInt(getCookie("avatar"))-1].className = "selected";
    function submitAvatar() {
        let btn = document.getElementById("submit_avatar");
        let notice = document.getElementById("notice_avatar");
        btn.style.backgroundColor = "orange";
        btn.style.fill = "white";
        notice.innerHTML = "正在处理";
        ajaxTo("POST", "../php/user/set_avatar.php", {avatar: avatarIndex}, function(json) {
            if(json.state == "success") {
                btn.style.backgroundColor = "green";
                document.getElementById("avatar").src = "../img/avatars/" + avatarIndex + ".png";
                notice.innerHTML = "成功";
            } else {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "错误：[" + json.code + "] " + json.msg;
            }
        });
    }

    //--------------------
    //  权重
    //--------------------
    var weights = getCookie("weight").split(",");
    let weightSet = document.getElementsByClassName("weight");
    for(let i = 0; i < weightSet.length; i++) {
        weightSet[i].value = weights[i];
    }
    function submitWeight() {
        let btn = document.getElementById("submit_weight");
        let notice = document.getElementById("notice_weight");
        btn.style.backgroundColor = "orange";
        btn.style.fill = "white";
        notice.innerHTML = "正在处理";
        for(let i = 0; i < weightSet.length; i++) {
            weights[i] = weightSet[i].value;
        }
        let newWeights = weights.join(",");
        ajaxTo("POST", "../php/user/set_weight.php", {weight: newWeights}, function(json) {
            if(json.state == "success") {
                btn.style.backgroundColor = "green";
                notice.innerHTML = "成功";
            } else {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "错误：[" + json.code + "] " + json.message;
            }
        });
    }

    //--------------------
    //  用户名
    //--------------------

    function submitUsername() {
        let type, key1, key2;
        let btn = document.getElementById("submit_username");
        let notice = document.getElementById("notice_username");
        btn.style.backgroundColor = "orange";
        btn.style.fill = "white";
        notice.innerHTML = "正在处理";
        if(document.getElementById("section_1_a").getAttribute("value") == 1) {
            type = "pw";
            key1 = document.getElementById("verify_pw").value;
            key2 = null;
            if(!key1) {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "请先输入顶部的验证密码";
                return;
            }
        } else {
            type = "qna";
            key1 = document.getElementById("verify_ans1").value;
            key2 = document.getElementById("verify_ans2").value;
            if(!(key1 && key2)) {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "请先输入顶部的密保问题";
                return;
            }
        }
        newUsername = document.getElementById("username").value;
        if(newUsername && newUsername.length < 64) {
            ajaxTo("POST", "../php/user/set_username.php?type="+type, {username:newUsername, key1: key1, key2: key2}, function(json) {
                if(json.state == "success") {
                    btn.style.backgroundColor = "green";
                    notice.innerHTML = "成功！今后请使用新用户名登陆";
                } else {
                    btn.style.backgroundColor = "red";
                    notice.innerHTML = "错误：[" + json.code + "] " + json.message;
                }
            });
        } else {
            btn.style.backgroundColor = "red";
            notice.innerHTML = newUsername ? "太短" : "太长";
        }
    }

    //--------------------
    //  密码
    //--------------------

    function submitPassword() {
        let type, key1, key2;
        let btn = document.getElementById("submit_password");
        let notice = document.getElementById("notice_password");
        btn.style.backgroundColor = "orange";
        btn.style.fill = "white";
        notice.innerHTML = "正在处理";
        if(document.getElementById("section_1_a").getAttribute("value")) {
            type = "pw";
            key1 = document.getElementById("verify_pw").value;
            key2 = null;
            if(!key1) {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "请先输入顶部的验证密码";
                return;
            }
        } else {
            type = "qna";
            key1 = document.getElementById("verify_ans1").value;
            key2 = document.getElementById("verify_ans2").value;
            if(!(key1 && key2)) {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "请先输入顶部的密保问题";
                return;
            }
        }
        let newPassword = document.getElementById("password").value;
        if(newPassword && newPassword == document.getElementById("password_repeat").value) {
            ajaxTo("POST", "../php/user/set_password.php?type="+type, {password:newPassword, key1: key1, key2: key2}, function(json) {
                if(json.state == "success") {
                    btn.style.backgroundColor = "green";
                    notice.innerHTML = "成功！今后请使用新密码登陆";
                    document.getElementById("password").value = "";
                    document.getElementById("password_repeat").value = "";
                    document.getElementById("verify_pw").value = "";
                } else {
                    btn.style.backgroundColor = "red";
                    notice.innerHTML = "错误：[" + json.code + "] " + json.message;
                }
            });
        } else {
            btn.style.backgroundColor = "red";
            notice.innerHTML = newPassword ? "两次输入的密码不同" : "请输入新密码";
        }
    }

    //--------------------
    //  密保
    //--------------------
    ajaxTo("POST", "../php/user/get_qna.php", {key:"uid"}, function(json) {
        if(json.state == "success") {
            if(json.q1 && json.q2) {
                let values_1 = document.getElementsByClassName("area_1_value_1");
                for(value_1 of values_1) {
                    value_1.innerHTML = json.q1;
                }
                let values_2 = document.getElementsByClassName("area_1_value_2");
                for(value_2 of values_2) {
                    value_2.innerHTML = json.q2;
                }
            } else {
                let hides = document.getElementsByClassName("area_1_hide");
                for(hide of hides) {
                    hide.style.display = "none";
                }
                let shows = document.getElementsByClassName("area_1_show");
                for(show of shows) {
                    show.style.display = "";
                }
            }
        }
    });
    function submitQna() {
        let type, key1, key2;
        let btn = document.getElementById("submit_qna");
        let notice = document.getElementById("notice_qna");
        btn.style.backgroundColor = "orange";
        btn.style.fill = "white";
        notice.innerHTML = "正在处理";
        if(document.getElementById("section_1_a").getAttribute("value")) {
            type = "pw";
            key1 = document.getElementById("verify_pw").value;
            key2 = null;
            if(!key1) {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "请先输入顶部的验证密码";
                return;
            }
        } else {
            type = "qna";
            key1 = document.getElementById("verify_ans1").value;
            key2 = document.getElementById("verify_ans2").value;
            if(!(key1 && key2)) {
                btn.style.backgroundColor = "red";
                notice.innerHTML = "请先输入顶部的密保问题";
                return;
            }
        }
        let newQ1 = document.getElementById("qna_q1").value;
        let newA1 = document.getElementById("qna_a1").value;
        let newQ2 = document.getElementById("qna_q2").value;
        let newA2 = document.getElementById("qna_a2").value;
        if(newQ1 && newA1 && newQ2 && newA2) {
            ajaxTo("POST", "../php/user/set_qna.php?type="+type, {q1: newQ1, a1: newA1, q2: newQ2, a2: newA2, key1: key1, key2: key2}, function(json) {
                if(json.state == "success") {
                    btn.style.backgroundColor = "green";
                    notice.innerHTML = "成功！您的密保问题已更新";
                } else {
                    btn.style.backgroundColor = "red";
                    notice.innerHTML = "错误：[" + json.code + "] " + json.message;
                }
            });
        } else {
            btn.style.backgroundColor = "red";
            notice.innerHTML = "请完整输入密保问题的答案";
            return;
        }
    }
</script>
</html>